{% extends 'base.html' %}
{% block title %} My Orders {% endblock title %}

{% load static %}
{% load custom_filters %}

<link rel="stylesheet" href="{% static 'style.css' %}" />

{% block body %}
<div class="container my-5">
  {% include 'messages.html' %}
  <h2 class="text-center mb-4">My Orders</h2>

  <!-- Order Type Filter -->
  <div class="mb-4 text-center">
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-outline-primary active" onclick="filterOrders('all')">All Orders</button>
      <button type="button" class="btn btn-outline-primary" onclick="filterOrders('rent')">Rental Orders</button>
      <button type="button" class="btn btn-outline-primary" onclick="filterOrders('lease')">Lease Orders</button>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="thead-dark">
        <tr>
          <th>Order ID</th>
          <th>Type</th>
          <th>Car Name</th>
          <th>Car Model</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Total Amount</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr class="order-row {% if order.is_lease %}lease-order{% else %}rental-order{% endif %}">
          <td>{{ forloop.counter }}</td>
          <td>
            <span class="badge {% if order.is_lease %}badge-info{% else %}badge-primary{% endif %}">
              {{ order.is_lease|yesno:"Lease,Rental" }}
            </span>
          </td>
          <td>{{ order.car.car_name }}</td>
          <td>{{ order.car.car_model.model_name }}</td>
          <td>{{ order.bill.pick_up_date }}</td>
          <td>
            {% if order.is_lease %}
              {{ order.bill.rent_end_date }}
            {% else %}
              {{ order.bill.rent_end_date }}
            {% endif %}
          </td>
          <td>â‚¹{{ order.bill.total_rent }}</td>
          <td>
            <span class="badge {% if order.is_approved %}badge-success{% else %}badge-warning{% endif %}">
              {{ order.is_approved|yesno:"Approved,Pending" }}
            </span>
          </td>
          <td>
            {% if not order.payment_status %}
            <form method="post" id="payment-form-{{ order.id }}">
              {% csrf_token %}
              <input type="hidden" name="order_id" value="{{ order.id }}" />
              <input type="hidden" name="bill_id" value="{{ order.bill.id }}" />
              <button type="button" class="btn btn-warning btn-sm" 
                      onclick="initiatePayment('{{ order.id }}', {{ order.bill.total_rent|multiply:100 }})">
                Repayment
              </button>
            </form>
            {% else %}
            <a href="{% url 'order_detail' order.id %}" class="btn btn-info btn-sm">View</a>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center">No orders found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function filterOrders(type) {
  const rows = document.querySelectorAll('.order-row');
  rows.forEach(row => {
    if (type === 'all') {
      row.style.display = '';
    } else if (type === 'lease') {
      row.style.display = row.classList.contains('lease-order') ? '' : 'none';
    } else {
      row.style.display = row.classList.contains('rental-order') ? '' : 'none';
    }
  });

  // Update active button
  document.querySelectorAll('.btn-group .btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
}

function initiatePayment(orderId, amount) {
  var options = {
    key: "{{ razorpay_key }}",
    amount: amount,
    currency: "INR",
    name: "Car Rental Service",
    description: "Payment for Order #" + orderId,
    handler: function (response) {
      document.getElementById('payment-form-' + orderId).submit();
    }
  };
  var rzp = new Razorpay(options);
  rzp.open();
}
</script>

<style>
.badge {
  padding: 8px 12px;
  font-size: 0.9em;
}
.btn-group .btn {
  min-width: 120px;
}
</style>
{% endblock body %}
